<script src="https://marcheprime.github.io/lib/aframe.min.js"></script>
<script src="https://marcheprime.github.io/lib/aframe-ar.js"></script>
<script src="https://marcheprime.github.io/lib/aframe-extras.loaders.min.js"></script>

<body style='margin : 0px; overflow: hidden;'>
  <script>
    var markerVisible = { "obj1": false, "obj2": false, "obj3": false };
    var markertrouve = { "obj1": false, "obj2": false, "obj3": false };
    var jeufini = false;

    AFRAME.registerComponent('registerevents', {
        init: function () 
        {
            let marker = this.el;
            var entity = document.querySelector('#s1');
            var entity2 = document.querySelector('#s2');
			var entity3 = document.querySelector('#s3');
          
            var mark1 = document.querySelector('#box1');
          
            var mark2 = document.querySelector('#box2');
            var mark2txt = document.querySelector('#obj2txttri');
            
            var mark3 = document.querySelector('#box3');
            var mark3txt = document.querySelector('#obj3txttri');
			
            marker.addEventListener('markerFound', function() {
                markerVisible[ marker.id ] = true;
                //console.log( markerVisible );
                //console.log('DEBUG markertrouve obj1:' + markertrouve['obj1'] + ' | obj2:' + markertrouve['obj2']);
                
				//premier objet:
                if( markerVisible['obj1'] == true && markertrouve['obj1'] == false && markertrouve['obj2'] == false && markertrouve['obj3'] == false){
                  mark1.setAttribute('visible',true);
				  
                  mark2.setAttribute('visible',true);
                  mark2txt.setAttribute('visible',false);
				  
                  entity.components.sound.playSound();
				  
                  markertrouve['obj1'] = true;
                }
				
				//deuxieme objet:
				if( markerVisible['obj2'] == true && markertrouve['obj1'] == true && markertrouve['obj2'] == false && markertrouve['obj3'] == false){
				  
                  mark3.setAttribute('visible',true);
                  mark3txt.setAttribute('visible',false);
				  
                  entity.components.sound.playSound();
				  
                  markertrouve['obj2'] = true;
                }
				
				//troisieme objet:
				if( markerVisible['obj3'] == true && markertrouve['obj1'] == true && markertrouve['obj2'] == true && markertrouve['obj3'] == false){
				  
                  entity2.components.sound.playSound();
				  
                  markertrouve['obj3'] = true;
                }
                
				////////////////////////////////////////////////
				//ERREURS:
                if( markerVisible['obj2'] == true && markertrouve['obj1'] == false && markertrouve['obj2'] == false && markertrouve['obj3'] == false){
                  entity3.components.sound.playSound();
                }
				
                if( markerVisible['obj3'] == true && markertrouve['obj1'] == false && markertrouve['obj2'] == false && markertrouve['obj3'] == false){
                  entity3.components.sound.playSound();
                }
				////
                if( markerVisible['obj3'] == true && markertrouve['obj1'] == true && markertrouve['obj2'] == false && markertrouve['obj3'] == false){
                  entity3.components.sound.playSound();
				  markertrouve['obj1'] = false;
				  markertrouve['obj2'] = false;
				  markertrouve['obj3'] = false;
				  mark1.setAttribute('visible',false);
				  
                  mark2.setAttribute('visible',false);
                  mark2txt.setAttribute('visible',true);
                }
                
				/////////////////////////////////////////////////////////////////////
				//JEU TERMINE:
                if( markertrouve['obj1'] && markertrouve['obj2'] && markertrouve['obj3'] && jeufini == false){
                  //entity2.components.sound.playSound();
                  jeufini = true;
                  //console.log('[JEU TERMINE !!!]');
                  setTimeout(openUrl, 5000); // Pause de 5 secondes

                  function openUrl(){
                     window .location.href = 'https://www.ville-marcheprime.fr';
                  }
                }
                
            });

            marker.addEventListener('markerLost', function() {
                markerVisible[ marker.id ] = false;
                //console.log( markerVisible );
            });
        }
    });
    
    </script>
  
	<a-scene embedded vr-mode-ui="enabled: false;" arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;" loading-screen="enabled: false;" renderer="logarithmicDepthBuffer: true;">
	
    <a-assets>
      <a-asset-item id="sound" src="https://marcheprime.github.io/lib/assets/victoire01.wav" response-type="arraybuffer"></a-asset-item>
      <a-asset-item id="sound2" src="https://marcheprime.github.io/lib/assets/victoire02.wav" response-type="arraybuffer"></a-asset-item>
      <a-asset-item id="sound3" src="https://marcheprime.github.io/lib/assets/mauvais2.wav" response-type="arraybuffer"></a-asset-item>
	  <a-asset-item id="cloche" src="https://marcheprime.github.io/lib/assets/scene_cloche.glb"></a-asset-item>
      <img id = "erreur" src = "https://marcheprime.github.io/lib/assets/erreur.png">
    </a-assets>

		<a-marker id='obj1' type="pattern" url="https://marcheprime.github.io/lib/data/N.patt" registerevents>
			<a-entity id="box1" rotation="0 90 -90" scale="1 1 1" animation-mixer="loop: repeat" gltf-model="#cloche" visible='true'</a-entity>
		</a-marker>
    
		<a-marker id='obj2' type="pattern" url="https://marcheprime.github.io/lib/data/O.patt" registerevents>
		  <a-plane id="obj2txttri" src = "#erreur" height = "1" width = "6" rotation = "-90 0 0" visible='true'></a-plane>
		  
		  <a-entity id="box2" rotation="0 90 -90" scale="1 1 1" animation-mixer="loop: repeat" gltf-model="#cloche" visible='false'</a-entity>
		</a-marker>
		
		<a-marker id='obj3' type="pattern" url="https://marcheprime.github.io/lib/data/P.patt" registerevents>
		  <a-plane id="obj3txttri" src = "#erreur" height = "1" width = "6" rotation = "-90 0 0" visible='true'></a-plane>
		  
		  <a-entity id="box3" rotation="0 90 -90" scale="1 1 1" animation-mixer="loop: repeat" gltf-model="#cloche" visible='false'</a-entity>
		</a-marker>
		
    <a-entity id='s1' sound="src: #sound; poolSize: 1;" autoplay="false"></a-entity>
    <a-entity id='s2' sound="src: #sound2; poolSize: 1;" autoplay="false"></a-entity>
	<a-entity id='s3' sound="src: #sound3; poolSize: 1;" autoplay="false"></a-entity>

		<a-entity camera></a-entity>

	</a-scene>  
</body>
